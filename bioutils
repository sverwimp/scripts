#!/bin/sh

set -eu

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

show_help() {
    cmd=$(basename "$0")
    cat << EOF
Usage: $cmd <subcommand>

Subcommands:
  help, -h, --help  Show this help message
  list              List all available scripts in the bioutils directory ($SCRIPT_DIR)
  info <name>       Show metadata about a script
  remove <name...>  Remove specified script(s) by name
  update            Updates all and installs new bioutils scripts from the upstream repository
  uninstall         Remove all scripts in the bioutils directory
  uninstall-all     Remove all scripts, the bioutils directory itself and the directory from PATH
EOF
}

# List all scripts in the scripts directory
list_scripts() {
    if [ ! -d "$SCRIPT_DIR" ]; then
        echo "Directory $SCRIPT_DIR does not exist" >&2
        return 1
    fi

    #echo "Available scripts in directory: $SCRIPT_DIR"
    for script in "$SCRIPT_DIR"/*; do
        [ -f "$script" ] && echo "$(basename "$script")"
    done
}

info_script() {
    script="$SCRIPT_DIR/$1"

    [ -f "$script" ] || {
        echo "Script not found: $1" >&2
        return 1
    }

    echo "Name:        $1"
    echo "Path:        $script"
    echo "Executable:  $( [ -x "$script" ] && echo yes || echo no )"
    echo "Modified:    $(date -r "$script" 2>/dev/null || stat -c %y "$script")"

    if head -n 1 "$script" | grep -q '^#!'; then
        echo "Interpreter: $(head -n 1 "$script")"
    else
        echo "Interpreter: compiled / unknown"
    fi

    file "$script"
}

# Remove scripts by name
remove_scripts() {
    if [ $# -eq 0 ]; then
        echo "Error: No script names provided for removal." >&2
        return 1
    fi

    for script_name in "$@"; do
        script_path="$SCRIPT_DIR/$script_name"
        if [ -f "$script_path" ]; then
            rm -- "$script_path"
            echo "Removed script: $script_name"
        else
            echo "Error: Script '$script_name' not found in $SCRIPT_DIR" >&2
        fi
    done
}

update_bioutils() {
    command -v git >/dev/null 2>&1 || {
        echo "git is required for update" >&2
        return 1
    }

    tmpdir=$(mktemp -d) || return 1
    trap 'rm -rf "$tmpdir"' EXIT INT TERM

    echo "Updating bioutils from upstream repository..."

    git clone https://github.com/sverwimp/scripts.git "$tmpdir" || return 1

    if [ ! -x "$tmpdir/install.sh" ]; then
        echo "install.sh not found or not executable" >&2
        return 1
    fi

    (
        cd "$tmpdir" || exit 1
        chmod +x install.sh
        ./install.sh "$SCRIPT_DIR"
    )

    echo "Update completed"
}

# Remove all scripts in the scripts directory
uninstall_bioutils() {
    if [ ! -d "$SCRIPT_DIR" ]; then
        echo "Directory $SCRIPT_DIR does not exist" >&2
        return 1
    fi

    find "$SCRIPT_DIR" -type f -exec rm -f -- {} +
    echo "Uninstalled all scripts in $SCRIPT_DIR"
}

# Remove all scripts and the scripts directory itself
uninstall_all() {
    if [ ! -d "$SCRIPT_DIR" ]; then
        echo "Directory $SCRIPT_DIR does not exist" >&2
        return 1
    fi

    cd / || return 1
    rm -rf -- "$SCRIPT_DIR"
    echo "Uninstalled all bioutils scripts and removed directory $SCRIPT_DIR"

    SHELL_NAME="$(basename "$SHELL")"
    case "$SHELL_NAME" in
        bash)
            RC_FILE="$HOME/.bashrc"
            ;;
        zsh)
            RC_FILE="$HOME/.zshrc"
            ;;
        fish)
            RC_FILE="$HOME/.config/fish/config.fish"
            ;;
        *)
            RC_FILE="$HOME/.profile"
            echo "  Warning: Using .profile (detected shell: $SHELL_NAME)"
            ;;
    esac

    # Remove PATH export added by installer
    if [ -f "$RC_FILE" ]; then
        # Delete the comment line and the following line (PATH export)
        sed -i.bak '/# Added by bioutils installer/{N;d;}' "$RC_FILE"
        echo "Removed PATH modification from $RC_FILE (backup saved as $RC_FILE.bak)"
    fi

}

cmd=${1:-}
if [ -z $cmd ]; then
    show_help
    exit 0
fi

shift 2> /dev/null || true

case "$cmd" in
    help|-h|--help)
        show_help
        ;;
    list)
        list_scripts
        ;;
    info)
        if [ $# -ne 1 ]; then
            echo "Error: 'info' requires exactly one argument: the script name" >&2
            exit 1
        fi
        info_script "$1"
        ;;
    remove)
        remove_scripts "$@"
        ;;
    update)
        update_bioutils
        ;;
    uninstall)
        uninstall_bioutils
        ;;
    uninstall-all)
        uninstall_all
        ;;
    *)
        echo "Unknown command: $cmd" >&2
        show_help >&2
        exit 1
        ;;
esac
